<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Clases - Reservas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.344.0/umd/lucide.min.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .card-shadow {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .card-shadow:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto p-6">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Sistema de Clases (Base de Datos)</h1>
                <p class="text-blue-600">Mostrando clases reales desde la base de datos con instructores y reservas</p>
            </div>
            <a href="/mis-reservas.html" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                Ver Mis Reservas ‚Üí
            </a>
        </div>

        <!-- Debug Info -->
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6" id="debugInfo">
            <h3 class="text-yellow-800 font-medium mb-2">üîç Informaci√≥n de depuraci√≥n</h3>
            <div id="debugDetails" class="text-sm text-yellow-700"></div>
        </div>

        <!-- Message Area -->
        <div id="message" class="hidden mb-6"></div>

        <!-- Classes Grid -->
        <div id="classesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4">
            <!-- Loading -->
            <div class="col-span-full text-center py-8">
                <div class="animate-spin inline-block w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full"></div>
                <p class="mt-2 text-gray-600">Cargando clases...</p>
            </div>
        </div>
    </div>

    <script>
        let classes = [];

        function getLevelColor(level) {
            const colors = {
                'principiante': 'bg-green-500',
                'intermedio': 'bg-yellow-500',
                'avanzado': 'bg-orange-500',
                'competici√≥n': 'bg-red-500'
            };
            return colors[level?.toLowerCase()] || 'bg-gray-500';
        }

        function getCategoryColor(category) {
            const colors = {
                'femenino': 'bg-pink-100 text-pink-800 border-pink-200',
                'masculino': 'bg-blue-100 text-blue-800 border-blue-200',
                'mixto': 'bg-purple-100 text-purple-800 border-purple-200',
                'infantil': 'bg-green-100 text-green-800 border-green-200'
            };
            return colors[category?.toLowerCase()] || 'bg-gray-100 text-gray-800 border-gray-200';
        }

        async function loadClasses() {
            try {
                const response = await fetch('/api/timeslots?clubId=club-1&date=2025-09-11');
                classes = await response.json();
                
                // Update debug info
                document.getElementById('debugDetails').innerHTML = `
                    Ranuras API: ${classes.length}<br>
                    Ranuras convertidas: ${classes.length}<br>
                    Conversiones fallidas: 0<br>
                    Fecha seleccionada: 2025-09-11<br>
                    Primera ranura de API: ${classes[0]?.id || 'N/A'}<br>
                    Primer espacio convertido: ${classes[0]?.id || 'N/A'}<br>
                    Horarios de la API: ${classes.map(c => {
                        const time = new Date(c.start).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                        return `${time}`;
                    }).join(', ')}
                `;
                
                displayClasses();
            } catch (error) {
                showMessage('Error cargando clases: ' + error.message, 'error');
            }
        }

        function displayClasses() {
            const container = document.getElementById('classesGrid');
            container.innerHTML = '';

            if (classes.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <p class="text-gray-600">No hay clases disponibles para hoy</p>
                    </div>
                `;
                return;
            }

            classes.forEach(cls => {
                const startTime = new Date(cls.start).toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                const endTime = new Date(cls.end).toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });

                const available = cls.bookedPlayers < cls.maxPlayers;
                const availableSpots = cls.maxPlayers - cls.bookedPlayers;
                const price = cls.totalPrice ? (cls.totalPrice / cls.maxPlayers).toFixed(0) : '20';
                
                const card = document.createElement('div');
                card.className = `card-shadow w-full h-full overflow-hidden border-0 bg-white rounded-lg transition-shadow duration-200`;
                
                card.innerHTML = `
                    <!-- Header con horario e instructor -->
                    <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <i data-lucide="clock" class="h-4 w-4"></i>
                                <span class="font-semibold text-sm">
                                    ${startTime} - ${endTime}
                                </span>
                            </div>
                            <div class="bg-white/20 text-white text-xs px-2 py-1 rounded">
                                90 minutos
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-2 mt-2">
                            <i data-lucide="user" class="h-4 w-4"></i>
                            <span class="text-sm font-medium truncate">
                                ${cls.instructorName || 'Instructor no asignado'}
                            </span>
                        </div>
                    </div>

                    <!-- Contenido principal -->
                    <div class="p-4 space-y-3">
                        <!-- Nivel y Categor√≠a -->
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 rounded-full ${getLevelColor(cls.level)}"></div>
                                <span class="text-sm font-medium text-gray-700">
                                    ${cls.level || 'abierto'}
                                </span>
                            </div>
                            
                            <div class="border text-xs px-2 py-1 rounded ${getCategoryColor(cls.category)}">
                                ${cls.category || 'abierta'}
                            </div>
                        </div>

                        <!-- Cancha -->
                        <div class="flex items-center space-x-2 text-gray-600">
                            <i data-lucide="map-pin" class="h-4 w-4"></i>
                            <span class="text-sm">
                                Cancha
                            </span>
                        </div>

                        <!-- Precio -->
                        <div class="flex items-center space-x-2">
                            <i data-lucide="euro" class="h-4 w-4 text-green-600"></i>
                            <span class="font-semibold text-lg text-green-600">
                                ${price}‚Ç¨
                            </span>
                            <span class="text-sm text-gray-500">por persona</span>
                        </div>

                        <!-- Disponibilidad -->
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <i data-lucide="users" class="h-4 w-4 text-gray-500"></i>
                                <span class="text-sm text-gray-600">
                                    Disponibilidad
                                </span>
                            </div>
                            <div class="flex items-center space-x-1">
                                <div class="w-2 h-2 ${available ? 'bg-green-500' : 'bg-red-500'} rounded-full"></div>
                                <span class="text-sm font-medium ${available ? 'text-green-600' : 'text-red-600'}">
                                    ${available ? `${availableSpots} lugares libres` : 'Completo'}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Footer con bot√≥n de reserva -->
                    <div class="px-4 pb-4">
                        <button
                            onclick="bookClass('${cls.id}')"
                            ${!available ? 'disabled' : ''}
                            class="w-full ${available ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-300 cursor-not-allowed'} text-white font-medium py-2 px-4 rounded transition-colors"
                            id="btn-${cls.id}"
                        >
                            ${available ? `Reservar plaza (${price}‚Ç¨)` : 'Completo'}
                        </button>
                    </div>
                `;
                
                container.appendChild(card);
            });

            // Initialize Lucide icons
            lucide.createIcons();
        }

        async function bookClass(classId) {
            const button = document.getElementById(`btn-${classId}`);
            button.disabled = true;
            button.innerHTML = `
                <div class="flex items-center justify-center space-x-2">
                    <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                    <span>Reservando...</span>
                </div>
            `;
            
            try {
                const response = await fetch('/api/classes/book', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        timeSlotId: classId,
                        userId: 'user-alex-test'
                    }),
                });

                const result = await response.json();
                
                if (response.ok) {
                    showMessage('¬°Reserva exitosa! ' + result.message, 'success');
                    loadClasses(); // Recargar clases
                } else {
                    showMessage('Error: ' + result.message, 'error');
                    button.disabled = false;
                    button.innerHTML = 'Reservar plaza';
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
                button.disabled = false;
                button.innerHTML = 'Reservar plaza';
            }
        }

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = `mb-6 p-4 rounded-lg ${
                type === 'success' 
                    ? 'bg-green-100 text-green-800 border border-green-200' 
                    : 'bg-red-100 text-red-800 border border-red-200'
            }`;
            messageDiv.textContent = text;
            messageDiv.classList.remove('hidden');
            
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.classList.add('hidden');
                }, 3000);
            }
        }

        // Cargar clases al inicio
        loadClasses();
    </script>
</body>
</html>
